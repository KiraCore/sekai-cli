---
name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Check formatting
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Code is not formatted:"
            gofmt -l .
            exit 1
          fi

      - name: Run go vet
        run: go vet ./...

  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Build
        run: |
          CGO_ENABLED=0 go build -o sekai-cli ./cmd/sekai-cli
          ./sekai-cli --help

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint]
    env:
      CONTAINER: sekin-sekai-1
      CHAIN_ID: testnet-1
      SEKAI_CONTAINER: sekin-sekai-1
      SEKAI_CHAIN_ID: testnet-1
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Build sekai-cli
        run: CGO_ENABLED=0 go build -o sekai-cli ./cmd/sekai-cli

      - name: Clone sekin repository
        run: git clone --depth 1 https://github.com/kiracore/sekin.git /tmp/sekin

      - name: Start SEKAI infrastructure
        run: |
          cd /tmp/sekin
          docker compose up -d sekai syslog-ng
          echo "Waiting for containers to start..."
          sleep 10
          docker ps

      - name: Initialize SEKAI network
        run: |
          # Run the spin-local-testnet script steps (except start which blocks)
          echo ">>> Step 1: Initialize sekaid"
          docker exec ${CONTAINER} /scaller init --chain-id "${CHAIN_ID}" --moniker "CI-Node"

          echo ">>> Step 2: Add genesis key"
          docker exec ${CONTAINER} /scaller keys-add --name genesis

          echo ">>> Step 3: Add genesis account"
          docker exec ${CONTAINER} /scaller add-genesis-account --name genesis --coins 300000000000000ukex

          echo ">>> Step 4: Claim validator role"
          docker exec ${CONTAINER} /scaller gentx-claim --name genesis --moniker "CI-Validator"

          echo ">>> Step 5: Start sekaid (background with auto-restart)"
          docker exec -d ${CONTAINER} /scaller start --restart always

          echo "Waiting for node to start producing blocks..."
          sleep 30

      - name: Wait for chain to be ready
        run: |
          echo "Checking chain status..."
          for i in {1..30}; do
            if docker exec ${CONTAINER} /sekaid status 2>/dev/null | grep -q '"catching_up":false'; then
              echo "Chain is ready and synced!"
              docker exec ${CONTAINER} /sekaid status
              exit 0
            fi
            echo "Attempt $i/30: Chain not ready yet, waiting..."
            sleep 5
          done
          echo "Chain did not become ready in time"
          docker exec ${CONTAINER} /sekaid status || true
          exit 1

      - name: Run sekai-cli status check
        run: ./sekai-cli status

      - name: Run scenario-based integration test
        run: ./sekai-cli scenario run examples/scenarios/ci-integration-test.yaml

      - name: Run Go integration tests
        run: go test -v -timeout 30m -p 1 ./test/integration/...

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo "=== SEKAI container logs ==="
          docker logs ${CONTAINER} 2>&1 | tail -200 || true
          echo "=== Syslog logs ==="
          docker logs sekin-syslog-ng-1 2>&1 | tail -100 || true

      - name: Cleanup
        if: always()
        run: |
          cd /tmp/sekin
          docker compose down -v || true
